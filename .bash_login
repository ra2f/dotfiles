#!/usr/bin/env bash
# shellcheck disable=SC1090,SC1091
#
# executed by bash(1) for login-shells
#

if [[ -f "${HOME}/.bashrc" ]] && [[ "$-" == *i* ]]; then
    source "${HOME}/.bashrc"
fi

# Ssh agent
# =========

should_launch_ssh_agent() {
    [[ -x /usr/bin/ssh-agent ]] && [[ -z "${SSH_AGENT_PID}" ]] && [[ -z "${SSH_TTY}" ]]
}

if should_launch_ssh_agent; then
    eval $(keychain --quiet --noask --eval)
fi

unset should_launch_ssh_agent

# Display
# =======

# set DISPLAY to use X terminal in WSL
if grep -q WSL2 /proc/version; then
    # execute route.exe in the windows to determine its IP address
    export DISPLAY=$(route.exe print | grep 0.0.0.0 | head -1 | awk '{print $4}'):0.0

else
    # In WSL1 the DISPLAY can be the localhost address
    if grep -q icrosoft /proc/version; then
        export DISPLAY=127.0.0.1:0.0
    fi

fi
# Automatically execute vcxsrv.exe on host machine quietly
if command -v tasklist.exe >/dev/null && \
            ! tasklist.exe "/fi" "IMAGENAME eq vcxsrv.exe" "/fo" "CSV" | \
            grep "\"vcxsrv\.exe\"" >/dev/null ; then
    ("/mnt/c/Program Files/VcXsrv/vcxsrv.exe"  :0 -ac -terminate -lesspointer -multiwindow -clipboard -wgl >/dev/null 2>&1 &) 2>/dev/null
fi

# Show who is here if it is a login, interactive shell
# ====================================================

if shopt -q login_shell && [[ $- == *i* ]]; then
    case "$(tr '\0' ' ' <"/proc/${PPID}/cmdline")" in
        login* | sshd*)
            if command -v who-is-here >/dev/null; then
                who-is-here
            fi
            ;;
    esac
fi
